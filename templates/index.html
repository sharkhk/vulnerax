<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VulneraX Ultimate Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Heroicons -->
  <script src="https://unpkg.com/heroicons@2.0.11/outline/index.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
  <!-- Toast Notifications -->
  <div id="toastContainer" class="fixed top-5 right-5 space-y-2 z-50" aria-live="polite"></div>
  <!-- Loader Overlay -->
  <div id="loader" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden" aria-hidden="true">
    <div class="loader rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
  </div>

  <!-- Top Bar -->
  <div class="bg-white dark:bg-gray-800 p-4 shadow flex flex-wrap items-center gap-4">
    <select id="tenantSelect" aria-label="Select Tenant" class="p-2 border rounded bg-gray-50 dark:bg-gray-700">
      <option>Default Tenant</option>
    </select>
    <input id="apiToken" type="text" placeholder="API token" class="flex-1 p-2 border rounded bg-gray-50 dark:bg-gray-700" />
    <button id="saveToken" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Token</button>
    <select id="paletteSelect" aria-label="Theme Palette" class="p-2 border rounded bg-gray-50 dark:bg-gray-700">
      <option value="indigo">Indigo</option>
      <option value="emerald">Emerald</option>
      <option value="rose">Rose</option>
    </select>
    <select id="langSelect" aria-label="Language" class="p-2 border rounded bg-gray-50 dark:bg-gray-700">
      <option value="en">English</option>
      <option value="ar">Arabic</option>
    </select>
    <button id="subscribeBtn" class="px-4 py-2 bg-yellow-500 text-white rounded">Subscribe</button>
  </div>

  <!-- Navigation & Search -->
  <nav class="bg-white dark:bg-gray-800 shadow p-4 flex items-center justify-between">
    <span class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">VulneraX</span>
    <div class="flex-1 mx-4 flex gap-2">
      <input id="search" type="search" placeholder="Search CVE or boolean query" aria-label="Search CVEs" class="flex-1 p-2 rounded border bg-gray-50 dark:bg-gray-700" />
      <button id="searchBtn" class="px-4 bg-indigo-500 text-white rounded">Search</button>
    </div>
    <div class="flex gap-2">
      <button id="exportBtn" class="px-3 py-1 bg-green-500 text-white rounded">Bulk Export</button>
      <button id="templateBtn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded">Template</button>
      <button id="webhookBtn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded">Webhooks</button>
      <button id="integrationBtn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded">Integrations</button>
    </div>
  </nav>

  <!-- Widgets -->
  <section id="widgetArea" class="max-w-7xl mx-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">Widget 1</div>
    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">Widget 2</div>
    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">Widget 3</div>
    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">Widget 4</div>
  </section>

  <!-- Charts -->
  <main class="max-w-7xl mx-auto p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <canvas id="timelineChart" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4"></canvas>
      <canvas id="severityChart" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4"></canvas>
      <canvas id="forecastChart" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4"></canvas>
    </div>
    <div id="heatmap" class="w-full h-64 mb-6 rounded-lg overflow-hidden"></div>
    <div id="cve-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" role="region" aria-label="CVE listings"></div>
  </main>

  <!-- Modals (omitted for brevity) -->

  <script>
    // Utility for toasts
    function showToast(msg, type='info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `px-4 py-2 rounded shadow text-white ${
        type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
      }`;
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Fetch and render CVEs
    let cveData = [];
    async function fetchCVEs() {
      document.getElementById('loader').classList.remove('hidden');
      try {
        const res = await fetch('/api/cves?days=30&limit=100');
        const json = await res.json();
        if (json.error) {
          showToast(`Error: ${json.error}`, 'error');
          return;
        }
        cveData = json.cves;
        renderCVEs(cveData);
        updateCharts(cveData);
        updateHeatmap(cveData);
      } catch (e) {
        showToast(`Fetch failed: ${e}`, 'error');
      } finally {
        document.getElementById('loader').classList.add('hidden');
      }
    }

    // Render CVE cards
    function renderCVEs(list) {
      const container = document.getElementById('cve-list');
      container.innerHTML = '';
      list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-4 rounded shadow';
        card.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <span class="font-bold">${c.id}</span>
            <span class="px-2 py-1 rounded-full text-sm font-medium ${
              c.cvssScore >= 7 ? 'bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-400' : 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-400'
            }">${c.cvssScore || 'N/A'}</span>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${c.publishedDate.slice(0,10)}</p>
          <p class="text-gray-800 dark:text-gray-200">${c.description.length > 100 ? c.description.slice(0,100) + '...' : c.description}</p>
        `;
        container.appendChild(card);
      });
    }

    // Charts using Chart.js
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    const timelineChart = new Chart(timelineCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'CVEs', data: [], fill: false }] },
      options: { scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
    });
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    const severityChart = new Chart(severityCtx, {
      type: 'doughnut',
      data: { labels: ['Low','Medium','High','Critical'], datasets: [{ data: [] }] }
    });

    function updateCharts(list) {
      const dates = {};
      const sevCount = [0,0,0,0];
      list.forEach(c => {
        const d = c.publishedDate.slice(0,10);
        dates[d] = (dates[d] || 0) + 1;
        const s = c.cvssScore || 0;
        if (s < 4) sevCount[0]++;
        else if (s < 7) sevCount[1]++;
        else if (s < 9) sevCount[2]++;
        else sevCount[3]++;
      });
      timelineChart.data.labels = Object.keys(dates);
      timelineChart.data.datasets[0].data = Object.values(dates);
      timelineChart.update();

      severityChart.data.datasets[0].data = sevCount;
      severityChart.update();
    }

    // Heatmap using Leaflet (placeholder without geodata)
    function updateHeatmap(list) {
      const map = L.map('heatmap').setView([20,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
      // For real implementation, map CVE to geo coords and add heat layer
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', fetchCVEs);
  </script>
</body>
</html>
